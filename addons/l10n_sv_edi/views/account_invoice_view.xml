<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_invoice_inherit_tree" model="ir.ui.view">
        <field name="name">account.move.inherit.tree</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_out_invoice_tree"/>
        <field name="arch" type="xml">
            <field name="payment_state" position="after">
                <field name="estado_dte" string="Estado DTE"
                       widget="badge"
                       decoration-danger="estado_dte == 'anulada'"
                       decoration-warning="estado_dte == 'no_facturado'"
                       decoration-success="estado_dte == 'procesado' or 'procesado_lote'"
                       decoration-info="estado_dte == 'procesado_contingencia'"
                />
                <field name="counter_firmas" string="Total Firmas" sum="Total de firmas" optional="show"/>

            </field>
            <field name="name" position="after">
                <field name="journal_id" string="Tipo de factura / Diario"/>
            </field>
        </field>
    </record>
    <record id="view_invoice_inherit_tree_credit" model="ir.ui.view">
        <field name="name">account.move.inherit.tree</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_out_credit_note_tree"/>
        <field name="arch" type="xml">
            <field name="payment_state" position="after">
                <field name="estado_dte" string="Estado DTE"
                       widget="badge"
                       decoration-danger="estado_dte == 'anulada'"
                       decoration-warning="estado_dte == 'no_facturado'"
                       decoration-success="estado_dte == 'procesado' or 'procesado_lote'"
                       decoration-info="estado_dte == 'procesado_contingencia'"
                />
                <field name="counter_firmas" string="Total Firmas" sum="Total de firmas" optional="show"/>

            </field>
            <field name="name" position="after">
                <field name="journal_id" string="Tipo de factura / Diario"/>
            </field>
        </field>
    </record>

    <!--    <record id="view_invoice_document_type_form" model="ir.ui.view">-->
    <!--        <field name="name">account.move.inherit.form.document</field>-->
    <!--        <field name="model">account.move</field>-->
    <!--        <field name="inherit_id" ref="account.view_invoice_form"/>-->
    <!--        <field name="arch" type="xml">-->
    <!--            <field name="journal_id" position="attributes">-->
    <!--                <attribute name="domain">[('type', '=', 'sale'), ('requires_allocation', '=', 'yes')]-->
    <!--                </attribute>-->

    <!--            </field>-->
    <!--        </field>-->
    <!--    </record>-->
    <!--    <record id="model_action_generate_json" model="ir.actions.server">-->
    <!--        <field name="name">Generar JSON DTE</field>-->
    <!--        <field name="model_id" ref="account.model_account_move"/>-->
    <!--        <field name="binding_model_id" ref="account.model_account_move"/>-->
    <!--        <field name="state">code</field>-->
    <!--        <field name="type">ir.actions.server</field>-->
    <!--        <field name="method">generate_json</field>-->
    <!--    </record>-->
    <record id="model_action_generate_json" model="ir.actions.server">
        <field name="name">Generar JSON DTE</field>
        <field name="model_id" ref="account.model_account_move"/>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="state">code</field>
        <field name="code">action = records.generate_json()</field>
    </record>

    <record id="model_action_generate_dte_lote" model="ir.actions.server">
        <field name="name">Generar DTE por lote</field>
        <field name="model_id" ref="account.model_account_move"/>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="state">code</field>
        <field name="code">action = records.generate_dte_lote()</field>
    </record>


    <record id="view_invoice_inherit_form" model="ir.ui.view">
        <field name="name">account.move.inherit.form</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <div class="oe_title">
                <widget name="web_ribbon" title="DTE Generado Correctamente"
                        attrs="{'invisible': ['|', ('estado_dte', 'not in', ('procesado', 'procesado_lote')), ('move_type', 'not in', ('out_invoice', 'out_refund', 'in_invoice', 'in_refund', 'out_receipt', 'in_receipt'))]}"/>
                <widget name="web_ribbon" title="DTE Anulado"
                        bg_color="bg-danger"
                        attrs="{'invisible': [('estado_dte', '!=', 'anulada')]}"/>
            </div>

            <xpath expr="//sheet//group//group[@id='header_left_group']" position="inside">
                <!-- Catálogo DTE, CAT-022 -->
                <field name="tipo_identificacion_receptor"
                       attrs="{'invisible':[('tipo_generacion_documento','!=','2')]}"/>
                <field name="is_company" attrs="{'invisible': True}"/>
                <field name="tipo_documento_otro"
                       attrs="{'invisible':[('tipo_identificacion_receptor','!=','37')]}"/>
                <field name="tipo_identificacion_receptor_otro"
                       attrs="{'invisible':[('tipo_identificacion_receptor','!=','37')]}"/>
                <field name="document_dui_move"
                       attrs="{'invisible':[('tipo_identificacion_receptor','!=','13')]}"/>
                <field name="document_nit"
                       attrs="{'invisible':[('tipo_identificacion_receptor','!=','36')]}"/>
                <field name="document_pasaporte"
                       attrs="{'invisible':[('tipo_identificacion_receptor','!=','03')]}"/>
                <field name="document_carnet_residente"
                       attrs="{'invisible':[('tipo_identificacion_receptor','!=','02')]}"/>
            </xpath>

            <xpath expr="//field[@name='payment_reference']" position="after">

                <!-- CAT-007 -->
                <field name="tipo_generacion_documento"
                       attrs="{'invisible':[('move_type','not in',('out_invoice', 'out_refund','in_invoice'))]}"/>

                <!-- CAT-009 -->
                <field name="tipo_establecimiento" attrs="{'invisible':[('tipo_generacion_documento','!=','2')]}"/>
                <field name="hora_final" attrs="{'invisible':[('tipo_transmision','!=','2')]}"
                       placeholder="formato HH:MM:SS"/>
                <field name="numero_correlativo" attrs="{'invisible':[('tipo_transmision','!=','2')]}"/>

            </xpath>

            <xpath expr="//field[@name='team_id']" position="before">
                <!-- <field name="servicio_medico"/> -->


                <!-- CAT-021 -->
                <field name="otros_documentos_asociados"/>
                <field name="cod_asociado"/>
                <field name="detalle_documento"/>

                <!-- CAT-008 -->
                <field name="codigo_tipo_servicio_medico"
                       attrs="{'invisible':[('otros_documentos_asociados','!=','3')]}"/>

                <!-- Campos relacionados a Factura Exportación -->

                <!-- <field name="modo_transporte"
                       attrs="{'invisible':[('otros_documentos_asociados','!=','4')]}"/> -->

                <field name="placa_trans"
                       attrs="{'invisible':[('otros_documentos_asociados','!=','4')]}"/>

                <field name="num_conductor"
                       attrs="{'invisible':[('otros_documentos_asociados','!=','4')]}"/>

                <field name="nombre_conductor"
                       attrs="{'invisible':[('otros_documentos_asociados','!=','4')]}"/>

            </xpath>


            <xpath expr="//notebook" position="inside">
                <page name="info_dte" string="DTE SV" attrs="{'invisible':['|','|',('state','in',('draft')), ('tipo_generacion_documento','!=',('2')),
                                   ('move_type','not in',('out_invoice', 'out_refund','in_invoice'))]}">
                    <group cols="4">
                        <group string="Detalles de Factura">

                            <field name="uuid_generation_code"/>


                            <field name="fecha_factura"/>

                            <!-- CAT-003 -->
                            <field name="modelo_facturacion" />

                            <!-- CAT-004 -->
                            <field name="tipo_transmision"/>

                            <!-- CAT-025 -->
                            <field name="titulo_a_que_se_remiten_bienes"
                                   attrs="{'invisible': [('number_journal', '!=', '04')]}"/>

                            <!-- CAT-026 -->
                            <field name="tipo_donacion" attrs="{'invisible': [('number_journal', '!=', '15')]}"/>


                            <field name="number_journal"/>


                            <!--                            <field name="limpiar_nc_ejecutado" invisible="1"/>-->

                            <!-- Número de Pago Electrónico -->

                            <field name="num_pago_electronico" attrs="{'invisible': [('number_journal', '=', '15')]}"/>

                            <button name="generate_codigo_uuid"
                                    title="Actualizar uuid"
                                    type="object"
                                    icon="fa-recycle"
                                    attrs="{'invisible': [('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>


                        </group>
                        <group string="Recepción de datos DTE">
                            <field name="estado_firmado" attrs="{'invisible':[('state','!=','posted')]}"/>
                            <!--                            <field name="documento_firmado" attrs="{'invisible':[('state','!=','posted')]}"/>-->
                            <field name="estado_dte" attrs="{'invisible':[('tipo_transmision','=','2')]}"/>
                            <field name="confirmacion"/>
                            <!--                            <field name="json_total"/>-->
                            <field name="qr_link" widget="image" options="{'zoom':true}"
                                   attrs="{'invisible':[('estado_dte','!=','procesado')]}"/>
                            <field name="qr_link" widget="image" options="{'zoom':true}"
                                   attrs="{'invisible':[('estado_dte','!=','procesado_lote')]}"/>


                            <!--                            <button name="firmar_documentos_fc"-->
                            <!--                                    string="Firmar Comprobante de Donación Electrónica"-->
                            <!--                                    type="object"-->
                            <!--                                    class="oe_edit_only oe_inline oe_highlight"-->
                            <!--                                    attrs="{'invisible': [('number_journal', '!=', '15')]}"/>-->


                            <button name="firmar_documentos_fc"
                                    string="Firmador consumidor final"
                                    type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '01'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>

                            <button name="firmar_documentos_fex"
                                    string="Firmador Exportación"
                                    type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '11'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>

                            <button name="firmar_documentos_ccf"
                                    string="Firmador crédito fiscal"
                                    type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '03'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>

                            <button name="firmar_documentos_ncre"
                                    string="Firmador Nota de crédito"
                                    type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '05'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>

                            <button name="firmar_documentos_ndeb"
                                    string="Firmador Nota de débito"
                                    type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '06'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>

                            <button name="firmar_documentos_nrem"
                                    string="Firmador Nota de remisión"
                                    type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '04'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>

                            <button name="limpiar_nc"
                                    string="Limpiar datos"
                                    type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|',('number_journal', 'not in', ('05','06')),
                                    ('confirmacion', '==', 'Sello no generado')]}"/>


                            <button name="firmar_documentos_cd"
                                    string="Firmar Comprobante de Donación Electrónica" type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '15'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>
                            />
                            <button name="firmar_documentos_cl"
                                    string="Firmar Comprobante de Liquidación Electrónica" type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '08'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>
                            />
                            <button name="firmar_documentos_fc_cd"
                                    string="Firmar Documento contable de Liquidación Electrónica" type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '09'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>
                            />
                            <button name="firmar_documentos_cr"
                                    string="Firmar Comprobante de Retención Electrónica" type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '07'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>
                            />

                            <button name="firmar_documentos_se"
                                    string="Firmar Sujeto Excluido" type="object"
                                    class="oe_edit_only oe_inline oe_highlight"
                                    attrs="{'invisible': ['|', ('number_journal', '!=', '14'), ('estado_dte', 'in', ('procesado', 'procesado_lote', 'procesado_contingencia', 'anulada'))]}"/>
                            />


                        </group>
                        <group string="Detalles de pago" name="detalles_pago">
                            <field name="forma_pago_id"
                            />
                            <field name="otra_forma_pago" attrs="{'invisible': [('forma_pago_id', '!=', 14)]}"/>
                        </group>


                        <group string="Detalles de invalidación" name="dte_invalidacion" attrs="{'invisible': [('estado_dte', '!=', 'anulada')]}">
                            <field name="uuid_generation_code_anuladado"/>
                            <field name="sello_recibido_anulado"/>
                            <field name="date_anulado"/>
                        </group>
                    </group>

                </page>

                <!-- CAT-005 -->
                <page name="contingencia" string="Contingencia"
                      attrs="{'invisible':[('tipo_transmision','!=','2')]}">
                    <group string="Métodos de Contingencia">
                        <field name="tipo_contingencia"/>
                        <field name="tipo_contingencia_otro" attrs="{'invisible':[('tipo_contingencia','!=','5')]}"/>

                        <!-- CAT-023 -->
                        <field name="tipo_documento_contingencia" attrs="{'invisible':[('tipo_transmision','=','2')]}"/>

                        <!-- CAT-024 -->
                        <field name="tipo_invalidacion" attrs="{'invisible':[('tipo_transmision','=','2')]}"/>

                        <field name="motivo_contig"/>
                    </group>
                    <group string="firmar DTE en contingencia">
                        <field name="estado_contingencia" attrs="{'invisible':[('state','!=','posted')]}"/>
                        <field name="estado_dte"/>
                        <field name="documento_firmado_contingencia" attrs="{'invisible':[('state','!=','posted')]}"/>
                        <field name="sello_recibido"/>
                        <field name="mensaje"/>
                        <button name="firmar_contingencia" type="object" string="firmar documento"
                                class="oe_edit_only oe_inline oe_highlight"/>

                    </group>
                </page>

            </xpath>
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="original_invoice_id"
                       domain="[('journal_id.document_type_sv', '=', '03')]"
                       attrs="{'invisible': [('number_journal', 'not in', ('05', '06','07'))], 'required': [('number_journal', 'in', ('05', '06','07'))]}"/>

                <!--                <field name="original_invoice_id"-->
                <!--                       domain="[('journal_id.document_type_sv', '=', '03')]"-->
                <!--                       attrs="{'invisible': [('number_journal', '!=', '06')]}"/>-->
            </xpath>
            <field name="ref" position="after">
                <field name="factura_cfdi" invisible="1"/>
            </field>
            <button name="action_invoice_sent" position="before">
                <button name="action_invoice_sent" type="object" string="Enviar por correo-e"
                        attrs="{'invisible':[('state', 'not in', ('cancel'))]}" groups="base.group_user"/>
            </button>
            <button name="button_draft" position="before">
                <button name="action_generate_dte" type="object" string="Generar DTE"
                        attrs="{'invisible':['|','|','|',('state','in',('draft','cancel')), ('estado_firmado','!=',('OK')),
                                   ('move_type','not in',('out_invoice', 'out_refund','in_invoice')),
                                   ('estado_dte','in',('procesado', 'procesado_lote','procesado_contingencia','anulada'))]}"
                        class="oe_highlight" groups="base.group_user"/>
                <button name="%(l10n_sv_edi.reason_cancelation_sat_wizard)d"
                        type="action"
                        string="Invalidar DTE"
                        attrs="{'invisible':['|','|',('state','in',('draft','cancel')), ('estado_dte','!=',('procesado')),
                                   ('move_type','not in',('out_invoice', 'out_refund'))]}"
                        class=" oe_highlight"
                        groups="base.group_user"/>
                <button name="%(l10n_sv_edi.reason_cancelation_sat_wizard)d"
                        type="action"
                        string="Invalidar DTE"
                        attrs="{'invisible':['|','|',('state','in',('draft','cancel')), ('estado_dte','!=',('procesado_lote')),
                                   ('move_type','not in',('out_invoice', 'out_refund','in_invoice'))]}"
                        class=" oe_highlight"
                        groups="base.group_user"/>
                <button name="contingencia_generador" type="object" string="Generar DTE de contigencia"
                        attrs="{'invisible':['|','|',('state','in',('draft','cancel')), ('estado_contingencia','!=',('OK')),
                                   ('move_type','not in',('out_invoice', 'out_refund'))]}"
                        class="oe_highlight" groups="base.group_user"/>
                <!--                <button name="action_cfdi_rechazada"-->
                <!--                        type="object"-->
                <!--                        string="Cambiar estado CFDI a factura correcta"-->
                <!--                        class="oe_highlight"-->
                <!--                        groups="base.group_user"-->
                <!--                        confirm="La factura va pasar a estado correcto y puede intentar cancelar nuevamente."/>-->
            </button>
        </field>
    </record>


    <record id="mymodule_message_wizard_form" model="ir.ui.view">
        <field name="name">mymodule.message.wizard.form</field>
        <field name="model">mymodule.message.wizard</field>
        <field name="arch" type="xml">
            <form>
                <field name="message" readonly="True"/>
                <footer>
                    <button name="action_close" string="Ok" type="object" default_focus="1" class="oe_highlight"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="view_move_type_line_sv" model="ir.ui.view">
        <field name="name">account.move.type.line</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='invoice_line_ids']/tree/field[@name='tax_ids']" position="after">
                <field name="move_type_ids"/>
            </xpath>
        </field>
    </record>

</odoo>